<!DOCTYPE html><html xmlns="http://www.w3.org/1999/html">  <head>    <title>WebSocket Example</title>    <script src="http://libs.baidu.com/jquery/2.1.4/jquery.min.js"></script>  </head>  <body>    登录用户ID：<input type="text" id="sendUserId" /></br>    接受用户ID：<input type="text" id="receivedUserId" /></br>    linkId：<input type="text" id="linkId" /></br>    发送消息内容：<input type="text" id="messageInput" /></br>    <br>    收到消息来自：<input type="text" id="messageSender"/><br>    接受消息内容：<input type="text" id="messageReceive" /></br>    <br>    <button onclick="closeWebSocket()">关闭WebSocket连接</button>    <br>    <button onclick="sendMessage()">发送</button>    <br>    <br>    <br>  <form  method="post" id="fileUploadForm" enctype="multipart/form-data">    <input type="text" id="textfield" class="txt" />    <input type="file" name="file" multiple="multiple" class="file" id="fileField" onchange="document.getElementById('textfield').value=this.files[0].name"/>    <button onclick="sendFile()">提交</button>  </form>    <script type="text/javascript">      var UserId = sessionStorage.getItem("userId");      var receivedUserId = sessionStorage.getItem("receiverId");      var linkId = sessionStorage.getItem("linkId");      var wsUrl = "ws://172.22.31.10:8085/websocket/" + UserId;      var ws = new WebSocket(wsUrl);      document.getElementById("sendUserId").value = UserId;      document.getElementById("receivedUserId").value = receivedUserId;      document.getElementById("linkId").value = linkId;      ws.onopen = function (event) {        console.log("WebSocket is open now.");        let OnlineInfo = {          linkId: linkId,          msgType: 1, //登录消息          senderId: UserId,          receiverId: receivedUserId,          msgBody: null,          sendTime: Date.now(),          isLatest: 0        };        ws.send(JSON.stringify(OnlineInfo));      };      function closeWebSocket() {        UserId = document.getElementById("sendUserId").value;        receivedUserId = document.getElementById("receivedUserId").value;        let OfflineInfo = {          linkId: linkId,          msgType: 5, //离线消息          senderId: UserId,          receiverId: receivedUserId,          msgBody: null,          sendTime: Date.now(),          isLatest: 0        };        ws.send(JSON.stringify(OfflineInfo));        ws.close();      }      ws.onmessage = function (event) {        var message = event.data;        var messageJson = JSON.parse(message);        console.log("Received message: " + message);        let  {          linkId,          msgType,          senderId,          receiverId,          msgBody,          sendTime,          isLatest        } = messageJson;        if(senderId != "SERVER") {          document.getElementById("messageSender").value = senderId;          document.getElementById("messageReceive").value = msgBody;        }      };      ws.onclose = function (event) {        console.log("WebSocket is closed now.");      };      function sendMessage() {        UserId = document.getElementById("sendUserId").value;        receivedUserId = document.getElementById("receivedUserId").value;        var message = document.getElementById("messageInput").value;        let operateInfo = {          linkId: linkId,          msgType: 2, //文字消息          senderId: UserId,          receiverId: receivedUserId,          msgBody: message,          sendTime: Date.now(),          isLatest: 0        };        ws.send(JSON.stringify(operateInfo));      }      function sendFile() {        var url = "/File/upload";        var obj = document.getElementById("fileField");        var len = obj.files.length;        for (var i = 0; i < len; i++){  // 这个里面可以根据自己的需要对文件进行过滤判断等操作          var fileName = obj.files[i].name;          uploadFile(url,obj.files[i],fileName);   // 执行单个文件的上传(每次都创建一个新的 form,并提交)        }      }      // ajax 上传单个文件对象      // url 为访问路径      // files 为上传文件数组      // success 为上传成功后执行方法      // fail 为上传文件失败执行的方法      function uploadFile(url,file,fileName,success,fail){        var form = new FormData();        form.append("file",file);        var ecFilePath = null;        $.ajax({          url:url,        //后台url          data: form,          cache: false,          async: false, //设置为同步ajax          type: "POST",          dataType: 'json',              //数据返回类型，可以是xml、json等          contentType: false,          processData: false, //默认为true，默认情况下，发送的数据将被转换为对象，设为false不希望进行转换          success: function (data) {      //成功，回调传来的success方法            console.log("ajax返回data：" + data);            ecFilePath = data.ecFilePath;            console.log("ecFilePath" + ecFilePath);          },          error: function (er) {          //失败，回调函数            fail(er);          }        });        //存一次文件发一条消息        //msgBody以        var msgBodyObj = {          "fileName" : fileName,          "ecFilePath" : ecFilePath        }        UserId = document.getElementById("sendUserId").value;        receivedUserId = document.getElementById("receivedUserId").value;        var message = document.getElementById("messageInput").value;        let operateInfo = {          linkId: linkId,          msgType: 4, //文件消息          senderId: UserId,          receiverId: receivedUserId,          msgBody: msgBodyObj, //文件名 + 文件路径          sendTime: Date.now(),          isLatest: 0        };        ws.send(JSON.stringify(operateInfo));      }      //重复发送心跳包保持链接      setInterval(() => {        UserId = document.getElementById("sendUserId").value;        let HeartBeat = {          linkId: null,          msgType: 0, //心跳消息          senderId: UserId,          receiverId: null,          msgBody: "ping",          sendTime: Date.now(),          isLatest: 0        };        ws.send(JSON.stringify(HeartBeat));        console.log("ping");      }, 30000);    </script>  </body></html>